FROM alpine
WORKDIR /
COPY ["target/dependency", "dependency"]
COPY ["target/classes", "classes"]
COPY ["target/malwarescanREST.jar", "malwarescanREST.jar"]

COPY commands.sh /commands.sh
RUN chmod +x commands.sh

RUN apk add --update supervisor && rm  -rf /tmp/* /var/cache/apk/*
RUN apk add --no-cache openjdk8-jre

RUN apk --no-cache add clamav-daemon freshclam clamav-libunrar supervisor

RUN apk --no-cache add clamav clamav-libunrar \
    && mkdir /run/clamav \
    && chown clamav:clamav /run/clamav

RUN sed -i 's/^#Foreground .*$/Foreground true/g' /etc/clamav/clamd.conf \
    && sed -i 's/^#TCPSocket .*$/TCPSocket 3310/g' /etc/clamav/clamd.conf \
    && sed -i 's/^#Foreground .*$/Foreground true/g' /etc/clamav/freshclam.conf

RUN freshclam --quiet

ADD supervisord.conf /etc/

EXPOSE 8080
EXPOSE 3310

ENTRYPOINT ["supervisord", "--nodaemon", "--configuration", "/etc/supervisord.conf"]